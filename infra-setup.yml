---
- name: Create an instance
  hosts: localhost
  gather_facts: no
  tasks:
  - name: create a instance
    gcp_compute_instance:
      name: "{{ item }}"
      machine_type: n1-standard-1
      disks:
      - auto_delete: 'true'
        boot: 'true'
        initialize_params:
          disk_size_gb: 10
          source_image: projects/centos-cloud/global/images/family/centos-7
      network_interfaces:
      - network:
        access_configs:
        - name: External NAT
          nat_ip:   
          type: ONE_TO_ONE_NAT
      state: present
      tags:
        items:
        - http-server
        - https-server
      zone: us-central1-a
      project: healthy-dolphin-245407
      auth_kind: serviceaccount
      service_account_file: "~/my_account.json"
    register: abc
    with_items:
    - build
    - test
    - release
    - deploy  
    - jenkins

    

  - name: Add host to groupname
    add_host: 
      hostname: "{{ abc.results[0].networkInterfaces[0].accessConfigs[0].natIP }}" 
      groupname: build
  
  - name: Add host to groupname
    add_host: 
      hostname: "{{ abc.results[1].networkInterfaces[0].accessConfigs[0].natIP }}" 
      groupname: test
  
  - name: Add host to groupname
    add_host: 
      hostname: "{{ abc.results[2].networkInterfaces[0].accessConfigs[0].natIP }}" 
      groupname: release

  - name: Add host to groupname
    add_host: 
      hostname: "{{ abc.results[3].networkInterfaces[0].accessConfigs[0].natIP }}" 
      groupname: deploy

  - name: Add host to groupname
    add_host: 
      hostname: "{{ abc.results[4].networkInterfaces[0].accessConfigs[0].natIP }}" 
      groupname: jenkins


- name: Manage build
  hosts: build
  become: true
  tasks:
  - name: install the  java,maven, git setup
    yum:
      name: ['git','java-1.8.0','java-1.8.0-devel','maven']
      state: present

- name: Manage sonar analysis instance
  hosts: test
  become: true
  roles:
  - sonar
- name: Manage release instances
  hosts: release
  become: true
  roles:
  - nexus
- name: Manage deploy instances
  hosts: deploy
  become: true
  roles:
  - tomcat

- name: Manage jenkins instances
  hosts: jenkins
  become: true
  roles:
  - jenkins
